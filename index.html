<!DOCTYPE html>
<html lang="en">
	<head>
		<title>OakSim</title>
		<script src="static/lib/codemirror.js"></script>
		<link rel="stylesheet" href="static/lib/codemirror.css">
		<script src="static/mode/gas/gas.js"></script>
		<!--<script src="static/lib/capstone.min.js"></script>-->
		<script src="static/lib/keystone.min.js"></script>
		<!--<script src="static/unicorn.min.js"></script>-->
		<!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">-->
		<link rel="stylesheet" href="static/styles/OakSim.css">
	</head>

	<body>
		<div id="content">
			<header id="header" class="panel">
				OakSim
			</header>
			<div id="main">
				<div class="content-left">
					<div class="panel" id="buttons">Buttons</div>
					<div class="panel" id="code">
						<textarea id="source" spellcheck="false" wrap="off"></textarea>
					</div>
					<div class="panel" id="messages">
					</div>
				</div>

				<div class="content-right">
					<div class="panel" id="registers">Registers<br>&emsp;r0: blah<br>&emsp;r1: blah<br>&emsp;r2: blah<br>&emsp;r3: blah<br>&emsp;r4: blah<br>&emsp;r5: blah</div>
					<div class="panel" id="memory"></div>
				</div>
			</div>
			<footer id="footer" class="panel">
				footer
			</footer>
		</div>


		<script>
			// Assembler
			var KeyStone = new ks.Keystone(ks.ARCH_ARM,ks.MODE_ARM);
			//KeyStone.option(ks.OPT_SYNTAX,ks.OPT_SYNTAX_INTEL);
			Log("Keystone initialized");

			// Emulator
			//var Unicorn = new uc.Unicorn(uc.ARCH_ARM,ks.MODE_LITTLE_ENDIAN);

			// Disassembler
			//var Capstone = new cs.Capstone(cs.ARCH_ARM,cs.MODE_ARM);

			var AssembleDelay = null;

			// CodeMirror
			var CodeMirrorInst = CodeMirror.fromTextArea(document.getElementById("source"),
			{
				autofocus: true,
				dragDrop: true,
				cursorBlinkRate: 250,
				lineNumbers: true,
				tabSize: 4,
				smartIndent: true,
				indentWithTabs: true,
				mode: "gas",
				theme: "OakSim",
			});

			CodeMirrorInst.on('change',function()
			{
				clearTimeout(AssembleDelay)
				AssembleDelay = setTimeout(function(){
					Assemble(CodeMirrorInst);
				},500);
			});

			Log("CodeMirror initialized");

			function HexByte(Value)
			{
				Value = Value < 0 ? (Value += 0x100) : Value;
				var Str = '00' + Value.toString(16).toUpperCase();
				return Str.slice(-2);
			}

			function Log(Message)
			{
				
				document.getElementById("messages").innerHTML = "<span>" + Message + "</span><br>" + document.getElementById("messages").innerHTML;
			}
			
			function Assemble(SourceObj)
			{
				var ElmMemory = document.getElementById("memory");
				CodeMirrorInst.getAllMarks().map(
					function( Mark )
					{
						Mark.clear();
					}
				);

				var Source = SourceObj.getValue();

				var Assembled;
				try
				{
					Assembled = KeyStone.asm(Source);
				}
				catch(error)
				{
					Assembled.failed = true;
				}

				if( Assembled.failed == true )
				{
					Log("Error assembling");
					// CodeMirrorInst.markText(
					// 	{line: Assembled.count, ch: 0},
					// 	{line: Assembled.count+1, ch: 0},
					// 	{
					// 		css: "background-color:red"
					// 	}
					// );

					// CodeMirrorInst.markText(
					// 	{line: Assembled.count+1, ch: 0},
					// 	{line: CodeMirrorInst.lineCount(), ch: 0},
					// 	{
					// 		css: "opacity: 0.5"
					// 	}
					// );
					return;
				}

				var MachineCode = Assembled.mc;

				var HexString = "";
				MachineCode.forEach(
					function(Byte){
						HexString += HexByte(Byte) + " ";
				});
				ElmMemory.innerHTML = HexString;
			}

			// Default program
			CodeMirrorInst.setValue("square:\n        mov     r3, r0\n        mul     r0, r3, r0\n        bx      lr");

		</script>
	</body>
</html>