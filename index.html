<!DOCTYPE html>
<html lang="en">
	<head>
		<title>OakSim</title>
		<script src="static/lib/codemirror.js"></script>
		<link rel="stylesheet" href="static/lib/codemirror.css">
		<script src="static/mode/gas/gas.js"></script>
		<!--<script src="static/lib/capstone.min.js"></script>-->
		<script src="static/lib/keystone.min.js"></script>
		<script src="static/lib/unicorn.min.js"></script>
		<!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">-->
		<link rel="stylesheet" href="static/styles/OakSim.css">
	</head>

	<body>
		<div id="content">
			<header id="header" class="panel">
				OakSim
			</header>
			<div id="main">
				<div class="content-left">
					<div class="panel" id="buttons">Buttons</div>
					<div class="panel" id="code">
						<textarea id="source" spellcheck="false" wrap="off"></textarea>
					</div>
					<div class="panel" id="messages">
					</div>
				</div>

				<div class="content-right">
					<div class="panel" id="registers"></div>
					<div class="panel" id="memory"></div>
				</div>
			</div>
			<footer id="footer" class="panel">
				footer
			</footer>
		</div>


		<script>
			var Context = (function()
			{
				// Util functions
				this.Assemble = function(Source)
				{
					var ElmMemory = document.getElementById("memory");
					// Context.CodeMirrorInst.getAllMarks().map(
					// 	function( Mark )
					// 	{
					// 		Mark.clear();
					// 	}
					// );

					var Assembled = this.Keystone.asm(Source);

					if( Assembled.failed == true )
					{
						Context.Log("Error assembling");
						// CodeMirrorInst.markText(
						// 	{line: Assembled.count, ch: 0},
						// 	{line: Assembled.count+1, ch: 0},
						// 	{
						// 		css: "background-color:red"
						// 	}
						// );

						// CodeMirrorInst.markText(
						// 	{line: Assembled.count+1, ch: 0},
						// 	{line: CodeMirrorInst.lineCount(), ch: 0},
						// 	{
						// 		css: "opacity: 0.5"
						// 	}
						// );
						return;
					}

					var MachineCode = Assembled.mc;
					this.Reset();
					this.Unicorn.mem_write(0x10000,MachineCode);
					// var HexString = "";
					// MachineCode.forEach(
					// 	function(Byte){
					// 		HexString += HexByte(Byte) + " ";
					// });
					// ElmMemory.innerHTML = HexString;
				}

				this.Log = function(Message)
				{
					
					document.getElementById("messages").innerHTML = "<span>" + Message + "</span><br>" + document.getElementById("messages").innerHTML;
				}
				var HexDump = function(Bytes, Offset, Length, Width)
				{
					Offset = Offset || 0;
					Length = Length || Math.min(Bytes.length,1024);
					Width = Width || 16;
					var Out = "";

					for(var i = 0; i < Length; i += Width)
					{
						var LineBytes = Bytes.slice(i,i+Width);
						var Hex = LineBytes.reduce(function(Line,i){return Line + " " + ('00'+ i.toString(16).toUpperCase()).slice(-2)},"0x" + ("00000000" + (i + Offset).toString(16).toUpperCase()).slice(-8) + ':');
						Out +=  Hex + "<br>";
					}
					return Out;
				};
				this.DrawMemory = function()
				{
					document.getElementById("memory").innerHTML = HexDump(
						this.Unicorn.mem_read(0x10000,4*1024),0x10000
					);
				}
				this.DrawRegisters = function()
				{
					document.getElementById("registers").innerHTML = 
						"Registers:<br>"+
						"&emsp;r0 : " + this.Unicorn.reg_read_i32(uc.ARM_REG_R0 ).toString(16) + "<br>" +
						"&emsp;r1 : " + this.Unicorn.reg_read_i32(uc.ARM_REG_R1 ).toString(16) + "<br>" +
						"&emsp;r2 : " + this.Unicorn.reg_read_i32(uc.ARM_REG_R2 ).toString(16) + "<br>" +
						"&emsp;r3 : " + this.Unicorn.reg_read_i32(uc.ARM_REG_R3 ).toString(16) + "<br>" +
						"&emsp;r4 : " + this.Unicorn.reg_read_i32(uc.ARM_REG_R4 ).toString(16) + "<br>" +
						"&emsp;r5 : " + this.Unicorn.reg_read_i32(uc.ARM_REG_R5 ).toString(16) + "<br>" +
						"&emsp;r6 : " + this.Unicorn.reg_read_i32(uc.ARM_REG_R6 ).toString(16) + "<br>" +
						"&emsp;r7 : " + this.Unicorn.reg_read_i32(uc.ARM_REG_R7 ).toString(16) + "<br>" +
						"&emsp;r8 : " + this.Unicorn.reg_read_i32(uc.ARM_REG_R8 ).toString(16) + "<br>" +
						"&emsp;r9 : " + this.Unicorn.reg_read_i32(uc.ARM_REG_R9 ).toString(16) + "<br>" +
						"&emsp;r10: " + this.Unicorn.reg_read_i32(uc.ARM_REG_R10).toString(16) + "<br>" +
						"&emsp;r11: " + this.Unicorn.reg_read_i32(uc.ARM_REG_R11).toString(16) + "<br>" +
						"&emsp;r12: " + this.Unicorn.reg_read_i32(uc.ARM_REG_R12).toString(16) + "<br>" +
						"&emsp;SP : " + this.Unicorn.reg_read_i32(uc.ARM_REG_SP).toString(16) + "<br>" +
						"&emsp;LR : " + this.Unicorn.reg_read_i32(uc.ARM_REG_LR).toString(16) + "<br>" +
						"&emsp;PC : " + this.Unicorn.reg_read_i32(uc.ARM_REG_PC).toString(16) + "<br>"
					;
				}
				this.Reset = function()
				{
					/*
					0x08000 - 0x10000 Stack
					0x10000 - 0x30000 Code memory
					0x40000 - 0x60000 Working memory
					*/
					// Stack
					this.Unicorn.mem_unmap(0x8000,0x8000);
					this.Unicorn.mem_map(0x8000,0x8000);
					this.Unicorn.reg_write_i32(uc.ARM_REG_SP,0x8000 + 0x8000);
					// Code
					this.Unicorn.mem_unmap(0x10000,0x30000);
					this.Unicorn.mem_map(0x10000,0x30000);
					this.Unicorn.reg_write_i32(uc.ARM_REG_IP,0x10000);
					// WRAM
					this.Unicorn.mem_unmap(0x40000,0x20000);
					this.Unicorn.mem_map(0x40000,0x20000);

					this.DrawRegisters();
				}
				// Assembler
				this.Keystone = new ks.Keystone(ks.ARCH_ARM,ks.MODE_ARM);
				//KeyStone.option(ks.OPT_SYNTAX,ks.OPT_SYNTAX_INTEL);
				this.Log("Keystone initialized");

				// Emulator
				this.Unicorn = new uc.Unicorn(uc.ARCH_ARM,ks.MODE_LITTLE_ENDIAN);
				this.Log("Unicorn initialized");

				// Disassembler
				//var Capstone = new cs.Capstone(cs.ARCH_ARM,cs.MODE_ARM);

				// Delay between changing the text box and assembling
				this.AssembleDelay = null;

				// CodeMirror
				this.CodeMirrorInst = CodeMirror.fromTextArea(document.getElementById("source"),
				{
					autofocus: true,
					dragDrop: true,
					cursorBlinkRate: 250,
					lineNumbers: true,
					tabSize: 4,
					smartIndent: true,
					indentWithTabs: true,
					mode: "gas",
					theme: "OakSim",
				});

				this.CodeMirrorInst.on('change',function()
				{
					clearTimeout(this.AssembleDelay)
					this.AssembleDelay = setTimeout(function()
					{
						Assemble(this.CodeMirrorInst.getValue());
						this.DrawMemory();
						this.DrawRegisters();
					},125);
				});
				// Default program
				this.CodeMirrorInst.setValue("square:\n\tmov r3, r0\n\tmul r0, r3, r0\n\tbx lr");
				this.Log("CodeMirror initialized");


				this.Reset();
				return this;
			})();

			function HexByte(Value)
			{
				Value = Value < 0 ? (Value += 0x100) : Value;
				var Str = '00' + Value.toString(16).toUpperCase();
				return Str.slice(-2);
			}
		</script>
	</body>
</html>