<!DOCTYPE html>
<html lang="en">
	<head>
		<title>OakSim</title>
		<script src="static/lib/codemirror.js"></script>
		<link rel="stylesheet" href="static/lib/codemirror.css">
		<script src="static/lib/capstone.min.js"></script>
		<script src="static/lib/keystone.min.js"></script>
		<script src="static/mode/gas/gas.js"></script>
		<!--<script src="static/unicorn.min.js"></script>-->
		<!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">-->
		<link rel="stylesheet" href="static/styles/OakSim.css">
	</head>

	<body>
		<div id="content">
		<code><pre class="frame"><textarea id="source" style="width:100%" spellcheck="false" autocorrect="off" wrap="off">
			</textarea></pre></code>
		<code><pre class="frame" id="assembly"></pre></code>
		</div>
		<script>
			// Assembler
			var KeyStone = new ks.Keystone(ks.ARCH_ARM,ks.MODE_ARM);
			//KeyStone.option(ks.OPT_SYNTAX,ks.OPT_SYNTAX_INTEL);

			// Emulator
			//var Unicorn = new uc.Unicorn(uc.ARCH_ARM,ks.MODE_LITTLE_ENDIAN);

			// Disassembler
			//var Capstone = new cs.Capstone(cs.ARCH_ARM,cs.MODE_ARM);

			// CodeMirror
			var CodeMirrorInst = CodeMirror.fromTextArea(document.getElementById("source"),
			{
				autofocus: true,
				dragDrop: true,
				cursorBlinkRate: 500,
				value: "main:\n\tmov r1,#1\n\tbl main\n",
				lineNumbers: true,
				tabSize: 4,
				smartIndent: true,
				indentWithTabs: true,
				mode: "gas",
				theme: "OakSim",
			});

			var ElmAssembly = document.getElementById("assembly");

			function HexByte(Value)
			{
				Value = Value < 0 ? (Value += 0x100) : Value;
				var Str = '00' + Value.toString(16).toUpperCase();
				return Str.slice(-2);
			}
			
			CodeMirrorInst.on('change',Assemble);

			function Assemble(SourceObj)
			{
				CodeMirrorInst.getAllMarks().map(
					function( Mark )
					{
						Mark.clear();
					}
				);

				var Source = SourceObj.getValue();

				var Assembled;
				try
				{
					Assembled = KeyStone.asm(Source);
				}
				catch(error)
				{
					Assembled.failed = true;
				}

				if( Assembled.failed == true )
				{
					PrintError("Error");
					CodeMirrorInst.markText(
						{line: Assembled.count, ch: 0},
						{line: Assembled.count+1, ch: 0},
						{
							css: "background-color:red"
						}
					);

					CodeMirrorInst.markText(
						{line: Assembled.count+1, ch: 0},
						{line: CodeMirrorInst.lineCount(), ch: 0},
						{
							css: "opacity: 0.5"
						}
					);
					return;
				}

				var MachineCode = Assembled.mc;

				var HexString = "";
				MachineCode.forEach(
					function(Byte){
						HexString += HexByte(Byte) + " ";
				});
				ElmAssembly.innerHTML = HexString;
			}

			function PrintError(Message)
			{
				
				ElmAssembly.innerHTML = "<span style=\"color:red\">" + Message + "</span>";
			}


			// Default program
			CodeMirrorInst.setValue("square:\n        mov     r3, r0\n        mul     r0, r3, r0\n        bx      lr");
			Assemble(CodeMirrorInst);

		</script>
	</body>
</html>